package com.tranzzo.android.sdk;

import android.annotation.SuppressLint;
import android.content.Context;
import androidx.annotation.NonNull;
import androidx.annotation.VisibleForTesting;
import com.tranzzo.android.sdk.view.Card;
import org.json.JSONException;
import org.json.JSONObject;

import java.text.*;
import java.util.*;

/**
 * Entry point for Tranzzo SDK API.
 */
@SuppressLint("SimpleDateFormat")
public class Tranzzo {
    
    @VisibleForTesting
    static final DateFormat DATE_TIME_PARSER;
    
    @VisibleForTesting
    static final String OOPS_MESSAGE_INTERNAL = "An error occurred within Tranzzo SDK. Send us exception log and we will try to do out best!";
    static final String OOPS_MESSAGE_SERVER = "An error occurred within Tranzzo SDK. Send us this message and we will try to do out best: ";
    
    static {
        DATE_TIME_PARSER = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss");
        DATE_TIME_PARSER.setTimeZone(TimeZone.getTimeZone("UTC"));
    }
    
    private final String apiToken;
    private final TranzzoApi api;
    private final TelemetryProvider telemetry;
    private final Log log;
    
    /**
     * Factory method for {@link Tranzzo}.
     * TODO: Add link to CDN docs, section: Android
     *
     * @param apiToken API Token generated by Tranzzo.
     */
    public static Tranzzo init(String apiToken) {
        return new Tranzzo(apiToken, new HttpTranzzoApi(BuildConfig.TRANZZO_ENDPOINT), new TelemetryUtils(), new AndroidLogAdapter());
    }
    
    /**
     * Private unstable constructor.
     *
     * @see #init(String)
     */
    @VisibleForTesting
    Tranzzo(String apiToken, TranzzoApi api, TelemetryProvider telemetry, Log log) {
        this.apiToken = apiToken;
        this.api = api;
        this.telemetry = telemetry;
        this.log = log;
    }
    
    public TokenResult tokenize(@NonNull final Card card, @NonNull final Context context) {
        if (!card.isValid()) {
            return TokenResult.failure(TrzError.mkInternal("Attempt to tokenize invalid card."));
        } else {
            return doTokenize(card, context);
        }
        
    }
    
    private TokenResult doTokenize(@NonNull final Card card, @NonNull final Context context) {
        try {
            SortedMap<String, Object> data = new TreeMap<>(card.toMap());
            data.putAll(telemetry.collect(context));
            
            log.debug("Request: " + data);
            
            TrzResponse response = api.tokenize(data, apiToken);
            
            if (response.success) {
                log.debug("Response [success]: " + response);
                return parseSuccess(response);
            } else {
                log.error("Response [failure]: " + response.body);
                return TokenResult.failure(TrzError.fromJson(new JSONObject(response.body)));
            }
            
        } catch (Exception ex) {
            String internalErrorId = UUID.randomUUID().toString();
            log.error(OOPS_MESSAGE_INTERNAL + " Error id: " + internalErrorId, ex);
            return TokenResult.failure(new TrzError(internalErrorId, OOPS_MESSAGE_INTERNAL));
        }
    }
    
    private TokenResult parseSuccess(TrzResponse response) throws JSONException, ParseException {
        JSONObject json = new JSONObject(response.body);
        return TokenResult.success(new CardToken(
                json.getString("token"),
                DATE_TIME_PARSER.parse(json.getString("expires_at")),
                json.getString("card_mask")
        ));
    }
    
    
}
